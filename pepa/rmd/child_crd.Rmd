`r i = {{i}}`

# {{i+1}}. Analysis for trait `r traits[i]`

```{r echo = FALSE}
lc <- ck.crd(traits[i], trt, dfr)
model <- aov(dfr[, traits[i]] ~ dfr[, trt])
model$terms[[2]] <- traits[i]
at <- anova(model)
rownames(at)[1] <- trt

# ANOVA with subsampling

show.anova.sub <- FALSE

if (!is.null(eu))
  if (dim(dfr)[1] < dim(dfr2)[1]) {
    model2 <- aov(dfr2[, traits[i]] ~ dfr2[, trt] + dfr2[, eu] %in% dfr2[, trt])
    model2$terms[[2]] <- traits[i]
    at2 <- anova(model2)
    at2[1, 4] <- at2[1, 3] / at2[2, 3]
    at2[1, 5] <- pf(at2[1, 4], at2[1, 1], at2[2, 1], lower.tail = FALSE)
    rownames(at2) <- c(trt, "Exp. Error", "Sampling Error")
    show.anova.sub <- TRUE
}
```

## {{i+1}}.1. Exploratory analysis

It is always good to have some visualization of your data. Below a histogram and a boxplot are shown.

```{r include = !is.null(eu), echo = TRUE, eval = FALSE}
# Keep a copy of full data
mydata.full <- mydata
# Get means for subsampling
mydata <- st4gi::docomp("mean", trait, c(treatment, experimental.unit), dfr = mydata)
```

```{r echo = TRUE, eval = FALSE}
par(mfrow = c(1, 2))
hist(mydata$trait)
boxplot(mydata$trait)
```

```{r echo = FALSE, fig.height = 5, fig.width = 10}
par(mfrow = c(1, 2))
hist(dfr[, traits[i]], main = paste("Histogram of", traits[i]), xlab = traits[i])
boxplot(dfr[, traits[i]], ylab = traits[i])
```

`r if (lc$ng < 10) {paste0("Since the number of ", trt.lab.s, " in your experiment is not so large, we can plot the data for each ", trt.lab, ":")}`

```{r include = lc$ng < 10, echo = TRUE, eval = FALSE}
st4gi::msdplot(trait, treatment, mydata, conf = 1, pch = 4)
```

```{r echo = FALSE}
if (lc$ng < 10)
  msdplot(traits[i], trt, dfr, conf = 1, xlab = trt.lab.sc, ylab = traits[i], pch = 4)
```

## {{i+1}}.2. ANOVA

You have fitted a linear model for a CRD. The ANOVA table for your model is:

```{r echo = TRUE, eval = FALSE}
model <- aov(trait ~ treatment, data = mydata)
# Anova table
at <- anova(model)
at
```

```{r echo = FALSE}
at
```

The coefficient of variation for this experiment is `r format(agricolae::cv.model(model), digits = 4)`%.
The p-value for `r trt.lab.s` is `r format(at[1, 5], digits = 4)`
`r if(at[1, 5] < 0.05) {"which is significant at the 5% level."} else {"which is not significant at the 5% level."}`

`r if(show.anova.sub) {"At the subsample level, the ANOVA table is:"}`

```{r include = show.anova.sub, echo = TRUE, eval = FALSE}
model.sub <- aov(trait ~ treatment + experimental.unit %in% treatment, data = mydata.full)
# Anova table with subsampling
at.sub <- anova(model.sub)
at.sub[1, 4] <- at.sub[1, 3] / at.sub[2, 3]
at.sub[1, 5] <- pf(at.sub[1, 4], at.sub[1, 1], at.sub[2, 1], lower.tail = FALSE)
rownames(at.sub)[2:3] <- c("Exp. Error", "Sampling Error")
at.sub
```

```{r echo = FALSE}
if (show.anova.sub)
  at2
```

`r if(show.anova.sub) {if (at2[2, 5] > 0.05) {"The p-value for the experimental error is non-significant which implies that plot to plot variation is low. Thus, fewer plots with more subsamples could be used."}}`

`r if(show.anova.sub) {if (at2[2, 5] < 0.05) {"The p-value for the experimental error is significant which implies that plot to plot variation is high. Thus, more plots could be used."}}`

## {{i+1}}.3. Assumptions

Don't forget the assumptions of the model. It is supposed that the errors are independent with a normal distribution and with the same variance for all the `r trt.lab.s`. The following residuals plots can help you evaluate this:

```{r echo = TRUE, eval = FALSE}
par(mfrow = c(1, 2))
plot(model, which = 1)
plot(model, which = 2)
```

```{r echo = FALSE, fig.height = 5, fig.width = 10}
par(mfrow = c(1, 2))
plot(model, which = 1)
plot(model, which = 2)
```

Any trend in the residuals in the left plot would violate the assumption of independence while a trend in the variability of the residuals --for instance a funnel shape-- suggests heterogeneity of variances. Deviation from the theoretical normal line on the right plot is a sign of lack of normality.

## {{i+1}}.4. `r trt.lab.c` means

`r if (at[1, 5] < 0.05) {paste("Below are the sorted means for each", trt.lab, "using the Fisher's Least Significant Difference method and the multiple comparisons method of Tukey, both at the 5% level. Letters indicate if there are significant differences")} else {paste("Because the effect of", trt.lab.s, "was not significant in the ANOVA, multiple comparison tests are not presented. The means of your", trt.lab.s, "are:")}`

`r if (at[1, 5] < 0.05) {paste0("### ", {{i+1}}, ".3.1. LSD test")}`

```{r include = at[1, 5] < 0.05, echo = TRUE, eval = FALSE}
agricolae::LSD.test(mydata$trait, mydata$treatment, at[2, 1], at[2, 3])$groups
```

```{r echo = FALSE}
if (at[1, 5] < 0.05) {
  means <- dfr[, traits[i]]
  agricolae::LSD.test(means, dfr[, trt], at[2, 1], at[2, 3])$groups
}
```

`r if (at[1, 5] < 0.05) {paste0("### ", {{i+1}}, ".3.2. Tukey test")}`

```{r include = at[1, 5] < 0.05, echo = TRUE, eval = FALSE}
agricolae::HSD.test(mydata$trait, mydata$treatment, at[2, 1], at[2, 3])$groups
```

```{r echo = FALSE}
if (at[1, 5] < 0.05)
  agricolae::HSD.test(means, dfr[, trt], at[2, 1], at[2, 3])$groups
```

```{r include = at[1, 5] > 0.05, echo = TRUE, eval = FALSE}
tapply(mydata$trait, mydata$treatment, mean, na.rm = TRUE)
```

```{r echo = FALSE}
if (at[1, 5] > 0.05)
  tapply(dfr[, traits[i]], dfr[, trt], mean, na.rm = TRUE)
```

## {{i+1}}.5. Variance components

Below are the variance components for this model, under the assumption that `r trt.lab.s` are random. Here the model is fitted using REML.

```{r echo = TRUE, eval = FALSE}
model <- lme4::lmer(trait ~ (1|treatment), data = mydata)
vc <- data.frame(lme4::VarCorr(model))
vc[, c(1, 4, 5)]
```

```{r echo = FALSE}
y <- dfr[, traits[i]]
g <- dfr[, trt]
ff <- as.formula(y ~ (1|g))
model <- lme4::lmer(ff)
vc <- data.frame(lme4::VarCorr(model))
vc[1, 1] <- trt
rownames(vc) <- vc[, 1]
vc <- vc[, c(4, 5)]
colnames(vc) <- c("Variance", "Std.Dev.")
vc
```
